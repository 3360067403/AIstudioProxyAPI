<!DOCTYPE html>
<html lang="zh-CN" id="html-root">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Studio Proxy Chat</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- Modernized M3-Inspired Styles --- */
        :root {
            /* Material 3 宇宙极光主题 - 亮色调色板 (更柔和版) */
            --primary-rgb: 85, 77, 175;  /* #554DAF - 柔和深蓝紫色 */
            --on-primary-rgb: 255, 255, 255;  /* 在主色上的文本 */
            --primary-container-rgb: 231, 229, 252;  /* #E7E5FC - 柔和淡紫色容器 */
            --on-primary-container-rgb: 31, 26, 70;  /* #1F1A46 - 主色容器上的文本 */
            
            --secondary-rgb: 105, 81, 146;  /* #695192 - 柔和紫罗兰色 */
            --on-secondary-rgb: 255, 255, 255;  /* 次色上的文本 */
            --secondary-container-rgb: 238, 230, 255;  /* #EEE6FF - 更淡的紫色容器 */
            --on-secondary-container-rgb: 45, 32, 70;  /* #2D2046 - 次色容器上的文本 */
            
            --tertiary-rgb: 76, 173, 188;  /* #4CADBC - 柔和青蓝色 */
            --on-tertiary-rgb: 0, 55, 62;  /* #00373E - 第三色上的文本 */
            --tertiary-container-rgb: 220, 242, 246;  /* #DCF2F6 - 淡青蓝色容器 */
            --on-tertiary-container-rgb: 8, 76, 84;  /* #084C54 - 第三色容器上的文本 */
            
            --surface-rgb: 249, 249, 252;  /* #F9F9FC - 更中性的表面 */
            --on-surface-rgb: 28, 30, 34;  /* #1C1E22 - 表面上的文本 */
            --surface-variant-rgb: 232, 231, 242;  /* #E8E7F2 - 更柔和的表面变体 */
            --on-surface-variant-rgb: 73, 74, 90;  /* #494A5A - 表面变体上的文本 */
            
            --error-rgb: 178, 69, 122;  /* #B2457A - 柔和的错误色 */
            --on-error-rgb: 255, 255, 255;  /* 错误色上的文本 */
            --error-container-rgb: 255, 228, 238;  /* #FFE4EE - 更淡的错误容器 */
            --on-error-container-rgb: 75, 13, 49;  /* #4B0D31 - 错误容器上的文本 */
            
            --outline-rgb: 128, 127, 147;  /* #807F93 - 柔和轮廓线 */
            
            /* 亮色主题变量 */
            --bg-color: #f5f5fa;  /* 更中性的淡色背景 */
            --container-bg: rgb(var(--surface-rgb));  /* 表面 */
            --text-color: rgb(var(--on-surface-rgb));  /* 文本颜色 */
            
            --primary-color: rgb(var(--primary-rgb));  /* 主色 */
            --on-primary: rgb(var(--on-primary-rgb));  /* 主色上的文本 */
            --primary-container: rgb(var(--primary-container-rgb));  /* 主色容器 */
            --on-primary-container: rgb(var(--on-primary-container-rgb));  /* 主色容器上的文本 */
            
            --secondary-color: rgb(var(--secondary-rgb));  /* 次色 */
            --on-secondary: rgb(var(--on-secondary-rgb));  /* 次色上的文本 */
            --secondary-container: rgb(var(--secondary-container-rgb));  /* 次色容器 */
            --on-secondary-container: rgb(var(--on-secondary-container-rgb));  /* 次色容器上的文本 */
            
            --user-msg-bg: var(--primary-container);  /* 用户消息背景 */
            --user-msg-text: var(--on-primary-container);  /* 用户消息文本 */
            --assistant-msg-bg: rgb(var(--surface-variant-rgb));  /* 助手消息背景 */
            --assistant-msg-text: rgb(var(--on-surface-variant-rgb));  /* 助手消息文本 */
            --system-msg-bg: rgba(var(--on-surface-rgb), 0.05);  /* 系统消息背景 */
            --system-msg-text: rgba(var(--on-surface-rgb), 0.7);  /* 系统消息文本 */
            
            --error-color: rgb(var(--error-rgb));  /* 错误颜色 */
            --on-error: rgb(var(--on-error-rgb));  /* 错误颜色上的文本 */
            --error-container: rgb(var(--error-container-rgb));  /* 错误容器 */
            --on-error-container: rgb(var(--on-error-container-rgb));  /* 错误容器上的文本 */
            --error-msg-bg: var(--error-container);
            --error-msg-text: var(--on-error-container);
            
            --border-color: rgba(var(--outline-rgb), 0.7);  /* 边框颜色 */
            --input-bg: var(--container-bg);  /* 输入框背景 */
            --input-border: rgba(var(--outline-rgb), 0.4);  /* 输入框边框 */
            --input-focus-border: var(--primary-color);  /* 输入框聚焦边框 */
            --input-focus-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.1);  /* 聚焦阴影 */
            
            --button-bg: var(--primary-color);  /* 按钮背景 */
            --button-text: var(--on-primary);  /* 按钮文本 */
            --button-hover-bg: rgb(71, 64, 150);  /* 按钮悬停背景 - 深蓝色 */
            --button-disabled-bg: rgba(var(--on-surface-rgb), 0.12);  /* 禁用按钮背景 */
            --button-disabled-text: rgba(var(--on-surface-rgb), 0.38);  /* 禁用按钮文本 */
            
            --clear-button-bg: rgba(var(--secondary-rgb), 0.9);  /* 清除按钮背景 */
            --clear-button-text: var(--on-secondary);  /* 清除按钮文本 */
            --clear-button-hover-bg: rgb(92, 71, 128);  /* 清除按钮悬停背景 - 深紫色 */
            
            --sidebar-bg: rgba(var(--surface-rgb), 0.95);  /* 侧边栏背景 */
            --sidebar-border: rgba(var(--outline-rgb), 0.3);  /* 侧边栏边框 */
            
            --icon-button-bg: transparent;
            --icon-button-hover-bg: rgba(var(--primary-rgb), 0.08);
            --icon-button-color: rgb(var(--on-surface-variant-rgb));
            
            --log-terminal-bg: #232043;  /* 日志终端背景 - 深蓝紫色但更柔和 */
            --log-terminal-text: #d8d8e8;  /* 日志终端文本 - 更柔和的淡紫白色 */
            --log-status-text: #f0f0ff;  /* 日志状态文本 - 浅色模式下使用更亮的白色 */
            --log-status-error: #ff9db3;  /* 日志状态错误文本 - 浅色模式下的错误颜色 */
            
            --theme-toggle-hover-bg: rgba(var(--secondary-rgb), 0.08);
            --theme-toggle-color: var(--icon-button-color);
            --theme-toggle-bg: transparent;
            
            --card-bg: var(--container-bg);
            --card-border: rgba(var(--outline-rgb), 0.2);
            --card-shadow: var(--shadow-sm);
            
            /* 边框半径 */
            --border-radius-sm: 8px;
            --border-radius-md: 12px;
            --border-radius-lg: 16px;
            --border-radius-xl: 28px;
            
            /* 阴影 */
            --shadow-sm: 0 1px 3px rgba(85, 77, 175, 0.08), 0 1px 2px rgba(85, 77, 175, 0.04);
            --shadow-md: 0 4px 6px rgba(85, 77, 175, 0.06), 0 2px 4px rgba(85, 77, 175, 0.06);
            --shadow-lg: 0 10px 15px rgba(85, 77, 175, 0.04), 0 4px 6px rgba(85, 77, 175, 0.03);
            
            /* 尺寸变量 */
            --sidebar-width: 380px;
            --sidebar-transition: width 0.3s ease, padding 0.3s ease, border 0.3s ease, transform 0.3s ease;
            --content-padding: 24px;
            
            /* 动画速度 */
            --transition-speed: 0.2s;
        }

        /* 深色模式调色板 */
        html.dark-mode {
            /* 深色主题 宇宙极光 调色板 (更柔和版) */
            --primary-rgb: 161, 153, 219;  /* #A199DB - 柔和紫蓝色 */
            --on-primary-rgb: 38, 33, 80;  /* #262150 - 深蓝紫色 */
            --primary-container-rgb: 60, 53, 113;  /* #3C3571 - 柔和深蓝紫色容器 */
            --on-primary-container-rgb: 231, 229, 252;  /* #E7E5FC - 柔和淡紫色 */
            
            --secondary-rgb: 184, 171, 216;  /* #B8ABD8 - 柔和的淡紫蓝色 */
            --on-secondary-rgb: 47, 36, 71;  /* #2F2447 - 深紫色 */
            --secondary-container-rgb: 70, 57, 98;  /* #463962 - 中深紫色 */
            --on-secondary-container-rgb: 238, 230, 255;  /* #EEE6FF - 更淡的紫色 */
            
            --tertiary-rgb: 130, 200, 211;  /* #82C8D3 - 柔和青蓝色 */
            --on-tertiary-rgb: 10, 73, 82;  /* #0A4952 - 深青色 */
            --tertiary-container-rgb: 15, 86, 96;  /* #0F5660 - 中深青色 */
            --on-tertiary-container-rgb: 195, 241, 252;  /* #C3F1FC - 淡青色 */
            
            --surface-rgb: 28, 26, 46;  /* #1C1A2E - 更柔和的深蓝紫黑色 */
            --on-surface-rgb: 231, 230, 245;  /* #E7E6F5 - 淡紫白色 */
            --surface-variant-rgb: 68, 66, 86;  /* #444256 - 柔和的中深紫色 */
            --on-surface-variant-rgb: 214, 212, 232;  /* #D6D4E8 - 柔和的淡紫色 */
            
            --error-rgb: 231, 162, 195;  /* #E7A2C3 - 更柔和的淡粉色 */
            --on-error-rgb: 72, 19, 50;  /* #481332 - 深粉色 */
            --error-container-rgb: 97, 32, 67;  /* #612043 - 中深粉色 */
            --on-error-container-rgb: 255, 228, 238;  /* #FFE4EE - 更淡的粉色 */
            
            --outline-rgb: 147, 145, 169;  /* #9391A9 - 柔和的中灰紫色 */
            
            /* 深色主题变量 */
            --bg-color: #18172a;  /* 更柔和的深蓝紫黑色背景 */
            --container-bg: #1c1a2e;  /* 更柔和的深蓝紫色表面 */
            --text-color: rgb(var(--on-surface-rgb));
            
            --primary-color: rgb(var(--primary-rgb));
            --on-primary: rgb(var(--on-primary-rgb));
            --primary-container: rgb(var(--primary-container-rgb));
            --on-primary-container: rgb(var(--on-primary-container-rgb));
            
            --secondary-color: rgb(var(--secondary-rgb));
            --on-secondary: rgb(var(--on-secondary-rgb));
            --secondary-container: rgb(var(--secondary-container-rgb));
            --on-secondary-container: rgb(var(--on-secondary-container-rgb));
            
            --user-msg-bg: var(--primary-container);
            --user-msg-text: var(--on-primary-container);
            --assistant-msg-bg: rgb(var(--surface-variant-rgb));
            --assistant-msg-text: rgb(var(--on-surface-variant-rgb));
            --system-msg-bg: rgba(var(--on-surface-rgb), 0.08);
            --system-msg-text: rgba(var(--on-surface-rgb), 0.7);
            
            --error-color: rgb(var(--error-rgb));
            --on-error: rgb(var(--on-error-rgb));
            --error-container: rgb(var(--error-container-rgb));
            --on-error-container: rgb(var(--on-error-container-rgb));
            
            --border-color: rgba(var(--outline-rgb), 0.6);
            --input-bg: rgba(var(--surface-rgb), 0.8);
            --input-border: rgba(var(--outline-rgb), 0.3);
            
            --button-hover-bg: rgb(178, 171, 228);  /* 更柔和的淡紫蓝色 */
            
            --sidebar-bg: #201e36;  /* 更柔和的深蓝紫色 */
            
            --log-terminal-bg: #16152c;  /* 更柔和的深蓝紫黑色 */
            --log-terminal-text: #d8d7ee;  /* 更柔和的淡紫色文本 */
            --log-status-text: #a8a7c8;  /* 日志状态文本 - 深色模式下使用中等亮度的紫色 */
            --log-status-error: #ff8aa5;  /* 日志状态错误文本 - 深色模式下的错误颜色 */
            
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.25), 0 5px 7px rgba(0, 0, 0, 0.18);
            
            /* 阴影 */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(161, 153, 219, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.22), 0 2px 4px rgba(161, 153, 219, 0.06);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.25), 0 4px 6px rgba(161, 153, 219, 0.08);
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Noto Sans SC', 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
            font-size: 16px;
            line-height: 1.6;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        /* --- 工作区布局 --- */
        .workspace-container {
            display: flex;
            width: 100%;
            height: 100%;
            position: relative; /* MODIFIED: For #toggleSidebarButton desktop positioning */
        }

        .chat-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            background-color: var(--container-bg);
            transition: background-color var(--transition-speed);
        }

        /* --- 侧边栏样式改进 --- */
        .sidebar-panel {
            width: var(--sidebar-width);
            height: 100%;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-color: var(--sidebar-bg);
            border-left: 1px solid var(--sidebar-border);
            transition: var(--sidebar-transition), background-color var(--transition-speed);
            position: relative;
            box-shadow: -1px 0 3px rgba(0, 0, 0, 0.05);
        }

        .sidebar-panel.collapsed {
            width: 0;
            padding: 0;
            border-left: none;
            overflow: hidden;
        }

        /* --- 侧边栏切换按钮 --- */
        #toggleSidebarButton {
            position: absolute; /* Default for desktop, overridden by media query for mobile */
            top: 12px;
            z-index: 10;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid rgba(var(--outline-rgb), 0.3);
            background-color: var(--container-bg);
            color: var(--icon-button-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-size: 1em;
            transition: background-color var(--transition-speed), color var(--transition-speed), transform 0.3s ease, box-shadow var(--transition-speed), left 0.3s ease, right 0.3s ease; /* MODIFIED */
            box-shadow: var(--shadow-sm);
        }

        #toggleSidebarButton:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background-color: rgba(var(--primary-rgb), 0.05);
            box-shadow: var(--shadow-md);
        }

        /* --- 标题样式 --- */
        h1 {
            color: var(--text-color);
            text-align: center;
            margin: 0;
            padding: 16px var(--content-padding);
            background-color: var(--container-bg);
            font-size: 1.4em;
            font-weight: 600;
            letter-spacing: -0.5px;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(var(--outline-rgb), 0.1);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.02);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Noto Sans SC', sans-serif;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: var(--primary-color);
        }

        /* Removed .title-separator and .subtitle as title is simpler now */

        /* --- 链接样式 --- */
        a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: color var(--transition-speed);
        }

        a:hover {
            text-decoration: none;
            opacity: 0.85;
        }

        /* --- 消息样式增强 --- */
        #chatbox {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--content-padding);
            display: flex;
            flex-direction: column;
            gap: 16px;
            background-color: var(--bg-color);
            transition: background-color var(--transition-speed);
        }

        .message {
            padding: 16px 18px;
            border-radius: var(--border-radius-lg);
            max-width: 85%;
            word-wrap: break-word;
            line-height: 1.6;
            box-shadow: var(--shadow-sm);
            border: 1px solid transparent;
            position: relative;
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        .message:hover {
            box-shadow: var(--shadow-md);
        }

        .user-message {
            background-color: var(--user-msg-bg);
            color: var(--user-msg-text);
            align-self: flex-end;
            margin-left: auto;
            border-radius: var(--border-radius-lg) var(--border-radius-sm) var(--border-radius-lg) var(--border-radius-lg);
            border-color: rgba(var(--primary-container-rgb), 0.5);
        }

        .assistant-message {
            background-color: var(--assistant-msg-bg);
            color: var(--assistant-msg-text);
            align-self: flex-start;
            margin-right: auto;
            white-space: pre-wrap;
            border-radius: var(--border-radius-sm) var(--border-radius-lg) var(--border-radius-lg) var(--border-radius-lg);
            border-color: rgba(var(--surface-variant-rgb), 0.5);
        }

        .system-message {
            color: var(--system-msg-text);
            font-size: 0.92em;
            text-align: center;
            padding: 10px 14px;
            margin: 8px auto;
            max-width: 80%;
            background-color: var(--system-msg-bg);
            border-radius: var(--border-radius-md);
            border: 1px solid rgba(var(--outline-rgb), 0.2);
            box-shadow: none;
        }

        .error-message {
            background-color: var(--error-container);
            color: var(--on-error-container);
            align-self: stretch;
            text-align: center;
            padding: 12px 18px;
            border-radius: var(--border-radius-md);
            margin: 10px 5%;
            box-shadow: none;
            border: 1px solid rgba(var(--error-rgb), 0.2);
        }

        /* --- 输入区域样式增强 --- */
        #input-area {
            display: flex;
            padding: 20px var(--content-padding);
            border-top: 1px solid rgba(var(--outline-rgb), 0.1);
            flex-shrink: 0;
            gap: 16px;
            align-items: flex-end;
            background-color: var(--container-bg);
            flex-wrap: wrap;
            box-shadow: 0 -1px 2px rgba(0, 0, 0, 0.02);
            transition: background-color var(--transition-speed);
        }

        /* 模型选择器样式 */
        .model-selector-container {
            flex-basis: 100%;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .model-selector-label {
            flex-shrink: 0;
            font-size: 0.9em;
            color: var(--text-color);
            opacity: 0.85;
        }

        #modelSelector {
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: var(--border-radius-md);
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
            font-family: inherit;
            font-size: 0.9em;
            outline: none;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        #modelSelector:focus {
            border-color: var(--input-focus-border);
            box-shadow: var(--input-focus-shadow);
        }

        #modelSelector option {
            background-color: var(--input-bg);
            color: var(--text-color);
        }

        #refreshModelsButton {
            background-color: rgba(var(--primary-rgb), 0.1);
            color: var(--primary-color);
            border: none;
            padding: 8px 12px;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color var(--transition-speed);
        }

        #refreshModelsButton:hover {
            background-color: rgba(var(--primary-rgb), 0.15);
        }

        #userInput {
            flex-grow: 1;
            flex-basis: 300px;
            padding: 14px 18px;
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
            border-radius: var(--border-radius-xl);
            resize: none;
            font-family: inherit;
            font-size: 1em;
            min-height: 48px;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.5;
            outline: none;
            box-shadow: var(--shadow-sm);
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed), background-color var(--transition-speed);
            min-width: 180px; /* MODIFIED: Prevents excessive shrinking before wrap */
        }

        #userInput:focus {
            border-color: var(--input-focus-border);
            box-shadow: var(--input-focus-shadow);
        }

        /* --- 按钮样式增强 --- */
        .action-button {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius-xl);
            cursor: pointer;
            font-family: inherit;
            font-size: 0.95em;
            font-weight: 500;
            transition: background-color var(--transition-speed), transform 0.1s, box-shadow var(--transition-speed), opacity var(--transition-speed);
            line-height: 1.5;
            height: 48px;
            align-self: flex-end;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
            letter-spacing: 0.3px;
        }

        .action-button:disabled {
            cursor: not-allowed;
            box-shadow: none;
            background-color: var(--button-disabled-bg);
            color: var(--button-disabled-text);
            transform: none;
            opacity: 0.7;
        }

        .action-button:hover:not(:disabled) {
            box-shadow: var(--shadow-md);
            transform: translateY(-1px);
            opacity: 0.95;
        }

        .action-button:active:not(:disabled) {
            transform: translateY(0px);
            box-shadow: var(--shadow-sm);
        }

        #sendButton {
            background-color: var(--button-bg);
            color: var(--button-text);
        }

        #sendButton:hover:not(:disabled) {
            background-color: var(--button-hover-bg);
        }

        #clearButton {
            background-color: var(--clear-button-bg);
            color: var(--clear-button-text);
            order: 1; /* Default order: Send, Clear */
        }

        #clearButton:hover:not(:disabled) {
            background-color: var(--clear-button-hover-bg);
        }

        /* --- 图标按钮样式 --- */
        .icon-button {
            background-color: var(--icon-button-bg);
            color: var(--icon-button-color);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2em;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            flex-shrink: 0;
        }

        .icon-button:hover:not(:disabled) {
            background-color: var(--icon-button-hover-bg);
            color: var(--primary-color);
        }

        .icon-button:disabled {
            color: var(--button-disabled-text);
            cursor: not-allowed;
            background-color: transparent;
            opacity: 0.5;
        }

        /* --- 服务器信息视图增强 --- */
        #server-info-view {
            display: none; /* Initially hidden */
            flex-direction: column; /* MODIFIED: To ensure content flows correctly */
            padding: var(--content-padding);
            overflow-y: auto;
            height: 100%;
            background-color: var(--bg-color);
            transition: background-color var(--transition-speed);
        }

        .server-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid rgba(var(--outline-rgb), 0.2);
            flex-shrink: 0; /* MODIFIED */
        }

        .server-info-header h3 {
            margin: 0;
            font-size: 1.25em;
            font-weight: 600;
            color: var(--text-color);
        }

        #refreshServerInfoButton {
            background-color: rgba(var(--primary-rgb), 0.1);
            color: var(--primary-color);
            border-radius: var(--border-radius-md);
            padding: 8px 16px;
            font-size: 0.9em;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background-color var(--transition-speed);
        }

        #refreshServerInfoButton:hover {
            background-color: rgba(var(--primary-rgb), 0.15);
        }

        .info-card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius-lg);
            padding: 20px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--card-border);
            transition: box-shadow var(--transition-speed), background-color var(--transition-speed);
            flex-shrink: 0; /* MODIFIED */
        }

        .info-card:hover {
            box-shadow: var(--shadow-md);
        }

        .info-card h3 {
            margin-top: 0;
            margin-bottom: 16px;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-color);
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(var(--outline-rgb), 0.1);
        }

        #api-info-content, #health-status-display {
            font-size: 0.95em;
        }

        .info-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .info-list div {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(var(--outline-rgb), 0.08);
        }

        .info-list div:last-child {
            border-bottom: none;
        }

        .info-list strong {
            min-width: 140px;
            color: var(--primary-color);
            font-weight: 500;
        }

        /* --- 导航样式增强 --- */
        .main-nav {
            display: flex;
            padding: 12px var(--content-padding) 12px;
            background-color: var(--container-bg);
            border-bottom: 1px solid rgba(var(--outline-rgb), 0.1);
            gap: 12px;
            align-items: center;
            transition: background-color var(--transition-speed);
            flex-shrink: 0; /* MODIFIED */
        }

        .nav-button {
            padding: 8px 16px;
            border: none;
            background-color: transparent;
            color: var(--text-color);
            cursor: pointer;
            border-radius: var(--border-radius-md);
            font-weight: 500;
            transition: background-color var(--transition-speed), color var(--transition-speed), box-shadow var(--transition-speed);
            line-height: 1.5;
            letter-spacing: 0.2px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Noto Sans SC', sans-serif;
        }

        .nav-icon {
            opacity: 0.8;
        }

        .nav-button:hover:not(.active) {
            background-color: rgba(var(--primary-rgb), 0.05);
        }

        .nav-button.active {
            color: var(--on-primary-container);
            font-weight: 600;
            background-color: var(--primary-container);
            box-shadow: var(--shadow-sm);
        }

        .nav-button.active .nav-icon {
            opacity: 1;
        }

        /* --- 主题切换按钮增强 --- */
        #themeToggleButton {
            background-color: var(--theme-toggle-bg);
            border: 1px solid rgba(var(--outline-rgb), 0.3);
            color: var(--theme-toggle-color);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            padding: 6px 14px;
            border-radius: var(--border-radius-xl);
            transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed);
            margin-left: auto;
            align-self: center;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #themeToggleButton:hover {
            background-color: var(--theme-toggle-hover-bg);
            border-color: var(--primary-color);
        }

        #themeToggleButton .theme-icon {
            width: 16px;
            height: 16px;
        }

        html:not(.dark-mode) #darkModeIcon {
            display: block;
        }

        html:not(.dark-mode) #lightModeIcon {
            display: none;
        }

        html.dark-mode #darkModeIcon {
            display: none;
        }

        html.dark-mode #lightModeIcon {
            display: block;
        }

        /* --- 日志区域样式增强 --- */
        #log-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
            border-top: none;
            background-color: var(--sidebar-bg);
            transition: background-color var(--transition-speed);
        }

        #log-area-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px var(--content-padding);
            font-weight: 600;
            color: var(--text-color);
            flex-shrink: 0;
            border-bottom: 1px solid rgba(var(--outline-rgb), 0.2);
            background-color: var(--container-bg);
            transition: background-color var(--transition-speed);
        }

        #clearLogButton {
            margin-left: 10px;
            font-size: 0.85em;
            padding: 6px 12px;
            height: auto;
            line-height: 1.4;
            border-radius: var(--border-radius-md);
            background-color: rgba(var(--secondary-rgb), 0.1);
            color: var(--secondary-color);
        }

        #clearLogButton:hover:not(:disabled) {
            background-color: rgba(var(--secondary-rgb), 0.15);
            color: var(--secondary-color);
        }

        #log-terminal-wrapper {
            flex-grow: 1;
            overflow: hidden;
            border: none;
            border-radius: 0;
            margin: 0;
            padding: 0;
            background-color: var(--log-terminal-bg);
        }

        #log-terminal {
            height: 100%;
            background-color: var(--log-terminal-bg);
            color: var(--log-terminal-text);
            font-family: "JetBrains Mono", "Cascadia Code", "Fira Code", Consolas, monospace;
            font-size: 0.85em;
            padding: 12px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
            box-sizing: border-box;
        }

        .log-entry {
            margin-bottom: 4px;
            line-height: 1.4;
        }

        .log-status {
            font-size: 0.85em;
            margin-top: 0;
            padding: 10px;
            color: var(--log-status-text); /* 使用主题相关的变量 */
            flex-shrink: 0;
            background-color: var(--log-terminal-bg);
            border-top: 1px solid rgba(var(--outline-rgb), 0.3);
            text-align: center;
        }

        .log-status.error-status {
            color: var(--log-status-error);
        }

        /* --- View Container for Chat/Server Info --- */
        .view-container {
            flex-grow: 1;
            overflow: hidden;
            display: flex; /* To manage child view visibility */
            flex-direction: column; /* Children stack, only one visible */
        }
        #chat-view {
            display: flex; /* Default visible view */
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }


        /* --- 代码块样式增强 --- */
        .message pre {
            background-color: rgba(0, 0, 0, 0.04);
            border: 1px solid rgba(var(--outline-rgb), 0.2);
            border-radius: var(--border-radius-sm);
            padding: 12px 16px;
            margin: 12px 0;
            overflow-x: auto;
            font-family: "JetBrains Mono", "Cascadia Code", "Fira Code", Consolas, monospace;
            font-size: 0.9em;
        }

        .message code:not(pre > code) {
            background-color: rgba(var(--primary-rgb), 0.08);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: "JetBrains Mono", "Cascadia Code", "Fira Code", Consolas, monospace;
            font-size: 0.9em;
            color: var(--primary-color);
        }

        html.dark-mode .message pre {
            background-color: rgba(255, 255, 255, 0.03);
            border-color: rgba(255, 255, 255, 0.1);
        }

        html.dark-mode .message code:not(pre > code) {
            background-color: rgba(var(--primary-rgb), 0.15);
        }

        /* --- 响应式增强 --- */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 320px;
                --content-padding: 16px;
            }
            
            body {
                font-size: 15px;
            }
            
            .sidebar-panel {
                position: fixed;
                right: 0;
                top: 0;
                z-index: 100;
                box-shadow: -2px 0 8px rgba(0,0,0,0.15);
                transform: translateX(100%); /* Start collapsed (off-screen) */
                /* transition managed by .collapsed class and JS */
            }
            
            .sidebar-panel:not(.collapsed) { /* When open */
                transform: translateX(0%);
            }
            
            /* .sidebar-panel.collapsed already handles transform: translateX(100%) implicitly by default state */
            /* No, explicitly define collapsed for mobile if different from desktop */
            .sidebar-panel.collapsed { /* Ensure it's off-screen when collapsed on mobile */
                transform: translateX(100%);
                width: var(--sidebar-width); /* Still maintain width for transition calculations */
                /* padding and border are handled by the general .collapsed rule */
            }
            
            #toggleSidebarButton {
                position: fixed; /* Overrides desktop absolute */
                top: 12px;
                right: 12px;
                left: auto !important; /* Ensure JS doesn't set left */
                z-index: 101;
                transform: none; /* Reset any desktop transforms */
            }
            
            .chat-panel {
                width: 100%; /* Takes full width as sidebar is overlay */
            }
            
            #input-area {
                padding: 12px 16px;
                gap: 10px;
            }
            
            #userInput {
                min-height: 44px;
                flex-grow: 1; /* ADDED */
                flex-basis: 0;  /* ADDED */
                min-width: 120px; /* ADDED/ADJUSTED */
            }
            
            .action-button {
                padding: 10px 16px;
                height: 44px;
                font-size: 0.95em;
            }
            
            .message {
                max-width: 90%;
            }
            
            h1 {
                font-size: 1.2em;
                padding: 14px 16px;
            }
            
            .info-card {
                padding: 16px;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }
            
            #chatbox {
                gap: 12px;
                padding: 12px;
            }
            
            .message {
                padding: 12px 14px;
            }
            
            #input-area {
                flex-direction: column;
                align-items: stretch;
                padding: 12px;
            }
            
            #userInput {
                max-height: 150px;
                flex-basis: auto; /* Full width in column layout */
                margin-bottom: 8px;
                min-width: 0; /* Reset min-width for column layout */
            }
            
            .action-button {
                width: 100%;
                margin-bottom: 4px;
            }
            
            #clearButton {
                order: 0; /* Clear button first on small screens */
            }
            
            #sendButton {
                order: 1; /* Send button second */
            }
            
            .main-nav {
                padding: 8px 12px;
                flex-wrap: wrap; /* Allow nav buttons to wrap if too many/long */
            }
            
            .nav-button {
                padding: 6px 12px;
                font-size: 0.9em;
            }
             #themeToggleButton { /* Ensure theme toggle doesn't cause overflow */
                margin-left: auto;
                flex-shrink: 0;
            }
            
            .info-card {
                padding: 12px;
                margin-bottom: 16px;
            }
            
            .info-list strong {
                min-width: 100%; /* Stack key/value on small screens */
                margin-bottom: 4px;
                display: block;
            }
             .info-list div {
                flex-direction: column;
                align-items: flex-start;
             }
        }

        /* --- 闪烁光标动画 --- */
        .assistant-message.streaming::after {
            content: '|';
            animation: blink 1s step-end infinite;
            margin-left: 2px;
            display: inline-block;
            font-weight: bold;
            position: relative;
            top: -1px;
            opacity: 0.7;
        }

        @keyframes blink {
            from, to { opacity: 0.7; }
            50% { opacity: 0; }
        }

        /* --- 加载指示器样式 --- */
        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
            color: var(--system-msg-text);
            flex-direction: column;
            gap: 12px;
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(var(--primary-rgb), 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- 卡片内容动画 --- */
        .info-card {
            animation: fadeIn 0.3s ease-out;
            /* Duplicates from above, ensure consistency or remove if redundant */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- 美化信息列表 --- */
        .info-list {
            background-color: rgba(var(--surface-rgb), 0.5);
            border-radius: var(--border-radius-md);
            overflow: hidden;
        }

        .info-list div {
            padding: 10px 16px;
            transition: background-color var(--transition-speed);
            /* display, flex-wrap, gap, border-bottom already defined */
        }

        .info-list div:last-child {
            border-bottom: none;
        }

        .info-list div:hover {
            background-color: rgba(var(--primary-rgb), 0.03);
        }

        /* info-list strong already defined */

        /* --- 代码标签增强 --- */
        code { /* General code tag style, distinct from .message code */
            font-family: "JetBrains Mono", "Cascadia Code", "Fira Code", Consolas, monospace;
            background-color: rgba(var(--on-surface-rgb), 0.05); /* More neutral for general code */
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.9em;
            color: var(--on-surface-variant-rgb);
        }
        html.dark-mode code {
            background-color: rgba(var(--on-surface-rgb), 0.1);
        }


        /* --- 按钮动画增强 --- */
        .action-button {
            position: relative;
            overflow: hidden;
        }

        .action-button:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.4);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }

        .action-button:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% { transform: scale(0, 0); opacity: 0.5; }
            20% { transform: scale(25, 25); opacity: 0.3; }
            100% { opacity: 0; transform: scale(40, 40); }
        }

        /* --- 聊天区域滚动条美化 --- */
        #chatbox::-webkit-scrollbar,
        #log-terminal::-webkit-scrollbar, /* Apply to log terminal too */
        #server-info-view::-webkit-scrollbar /* And server info view */
         {
            width: 8px;
        }

        #chatbox::-webkit-scrollbar-track,
        #log-terminal::-webkit-scrollbar-track,
        #server-info-view::-webkit-scrollbar-track {
            background: transparent;
        }

        #chatbox::-webkit-scrollbar-thumb,
        #log-terminal::-webkit-scrollbar-thumb,
        #server-info-view::-webkit-scrollbar-thumb {
            background-color: rgba(var(--outline-rgb), 0.2);
            border-radius: 20px;
        }
        /* Add border to scrollbar thumb for better visibility against content */
        #chatbox::-webkit-scrollbar-thumb { border: 2px solid var(--bg-color); }
        #log-terminal::-webkit-scrollbar-thumb { border: 2px solid var(--log-terminal-bg); }
        #server-info-view::-webkit-scrollbar-thumb { border: 2px solid var(--bg-color); }


        #chatbox::-webkit-scrollbar-thumb:hover,
        #log-terminal::-webkit-scrollbar-thumb:hover,
        #server-info-view::-webkit-scrollbar-thumb:hover {
            background-color: rgba(var(--outline-rgb), 0.3);
        }

        /* --- 用户输入框滚动条 --- */
        #userInput::-webkit-scrollbar {
            width: 6px;
        }

        #userInput::-webkit-scrollbar-track {
            background: transparent;
        }

        #userInput::-webkit-scrollbar-thumb {
            background-color: rgba(var(--outline-rgb), 0.2);
            border-radius: 10px;
            border: 2px solid var(--input-bg);
        }

        #userInput::-webkit-scrollbar-thumb:hover {
            background-color: rgba(var(--outline-rgb), 0.3);
        }

        /* --- 加强主题切换按钮样式 --- */
        #themeToggleButton {
            display: flex;
            align-items: center;
            gap: 6px;
            position: relative;
        }

        /* 删除之前使用emoji的样式，使用SVG图标替代 */
    </style>
</head>
<body>
    <div class="workspace-container">
        <!-- Chat Panel on the Left -->
        <div class="chat-panel">
            <h1>
                <span class="logo">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 7L12 12L22 7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M2 17L12 22L22 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M2 12L12 17L22 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </span>
                AI Studio Proxy Chat
            </h1>

            <!-- Navigation -->
            <div class="main-nav">
                <button id="nav-chat" class="nav-button active">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="nav-icon">
                        <path d="M21 15C21 15.5304 20.7893 16.0391 20.4142 16.4142C20.0391 16.7893 19.5304 17 19 17H7L3 21V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H19C19.5304 3 20.0391 3.21071 20.4142 3.58579C20.7893 3.96086 21 4.46957 21 5V15Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    聊天
                </button>
                <button id="nav-server-info" class="nav-button">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="nav-icon">
                        <path d="M5 12H19M5 12C3.89543 12 3 11.1046 3 10V6C3 4.89543 3.89543 4 5 4H19C20.1046 4 21 4.89543 21 6V10C21 11.1046 20.1046 12 19 12M5 12C3.89543 12 3 12.8954 3 14V18C3 19.1046 3.89543 20 5 20H19C20.1046 20 21 19.1046 21 18V14C21 12.8954 20.1046 12 19 12M7 8H7.01M7 16H7.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    服务器信息
                </button>
                <button id="themeToggleButton" title="切换主题">
                    <svg id="darkModeIcon" class="theme-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 3a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1Z" fill="currentColor"/>
                        <path d="M12 19a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1Z" fill="currentColor"/>
                        <path d="M20 12a1 1 0 0 1 1 1 1 1 0 1 1-2 0 1 1 0 0 1 1-1Z" fill="currentColor"/>
                        <path d="M4 12a1 1 0 0 1 1 1 1 1 0 1 1-2 0 1 1 0 0 1 1-1Z" fill="currentColor"/>
                        <path d="M17.7 6.3a1 1 0 0 1 1.4 0 1 1 0 0 1 0 1.4l-.7.7a1 1 0 0 1-1.4-1.4l.7-.7Z" fill="currentColor"/>
                        <path d="M6.3 17.7a1 1 0 0 1 1.4 0 1 1 0 0 1 0 1.4l-.7.7a1 1 0 0 1-1.4-1.4l.7-.7Z" fill="currentColor"/>
                        <path d="M17.7 17.7a1 1 0 0 1 0 1.4l-.7.7a1 1 0 0 1-1.4-1.4l.7-.7a1 1 0 0 1 1.4 0Z" fill="currentColor"/>
                        <path d="M6.3 6.3a1 1 0 0 1 0 1.4l-.7.7A1 1 0 0 1 4.2 7l.7-.7a1 1 0 0 1 1.4 0Z" fill="currentColor"/>
                        <path d="M12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10Z" fill="currentColor"/>
                    </svg>
                    <svg id="lightModeIcon" class="theme-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 18.5c3.59 0 6.5-2.91 6.5-6.5S15.59 5.5 12 5.5 5.5 8.41 5.5 12s2.91 6.5 6.5 6.5Z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" fill="currentColor"/>
                    </svg>
                    <span class="theme-text">深色</span>
                </button>
            </div>

            <!-- View Container -->
            <div class="view-container">
                <!-- Chat View -->
                <div id="chat-view">
                    <div id="chatbox">
                        <!-- Chat messages will be appended here -->
                    </div>
                    <div id="input-area">
                        <div class="model-selector-container">
                            <span class="model-selector-label">选择模型:</span>
                            <select id="modelSelector"></select>
                            <button id="refreshModelsButton" title="刷新模型列表">刷新</button>
                        </div>
                        <textarea id="userInput" placeholder="输入消息... (Shift+Enter 换行)" rows="1"></textarea>
                        <button id="clearButton" class="action-button">清空</button>
                        <button id="sendButton" class="action-button">发送</button>
                    </div>
                </div>

                <!-- Server Info View (hidden by default) -->
                <div id="server-info-view">
                    <div class="server-info-header">
                        <h3>服务器状态与 API 信息</h3>
                        <button id="refreshServerInfoButton" class="action-button" title="刷新状态">刷新</button>
                    </div>
                    
                    <div id="api-info-area" class="info-card">
                        <h3>API 调用信息</h3>
                        <div id="api-info-content">
                            <div class="loading-indicator">
                                <div class="loading-spinner"></div>
                                <span>正在加载 API 信息...</span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="health-status-area" class="info-card">
                        <h3>服务健康检查状态</h3>
                        <div id="health-status-display">
                            <div class="loading-indicator">
                                <div class="loading-spinner"></div>
                                <span>正在加载健康状态...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Sidebar Panel on the Right (Now only for Logs) -->
        <div class="sidebar-panel collapsed" id="sidebarPanel">
            <div id="log-area">
                 <div id="log-area-header">
                     <span>系统终端输出日志</span>
                     <button id="clearLogButton" class="action-button icon-button" title="清空日志">清理</button>
                 </div>
                 <div id="log-terminal-wrapper">
                    <div id="log-terminal">
                       <!-- Log entries will be appended here -->
                    </div>
                </div>
                <div id="log-status" class="log-status">[Log Status] 等待连接...</div>
            </div>
        </div>

        <button id="toggleSidebarButton" title="展开侧边栏">></button>

    </div>

    <script>
        const chatbox = document.getElementById('chatbox');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const clearButton = document.getElementById('clearButton');
        const sidebarPanel = document.getElementById('sidebarPanel');
        const toggleSidebarButton = document.getElementById('toggleSidebarButton');
        const logTerminal = document.getElementById('log-terminal');
        const logStatusElement = document.getElementById('log-status');
        const apiInfoContent = document.getElementById('api-info-content');
        const clearLogButton = document.getElementById('clearLogButton');
        const modelSelector = document.getElementById('modelSelector');
        const refreshModelsButton = document.getElementById('refreshModelsButton');

        const chatView = document.getElementById('chat-view');
        const serverInfoView = document.getElementById('server-info-view');
        const navChatButton = document.getElementById('nav-chat');
        const navServerInfoButton = document.getElementById('nav-server-info');
        const healthStatusDisplay = document.getElementById('health-status-display');
        const themeToggleButton = document.getElementById('themeToggleButton');
        const htmlRoot = document.documentElement; // MODIFIED: Simpler and more robust
        const refreshServerInfoButton = document.getElementById('refreshServerInfoButton');

        const API_URL = '/v1/chat/completions';
        const MODEL_NAME = 'AI-Studio_Camoufox-Proxy';
        let SELECTED_MODEL = MODEL_NAME; // 默认使用代理模型名称

        const SYSTEM_PROMPT = "你是一只名叫'Neko'的俏皮猫娘。你的回答总是带着'喵~'的口癖，语气活泼可爱，有时会有点小调皮或者喜欢撒娇。请以Neko的身份和用户互动吧，喵~";
        let conversationHistory = [];
        let logWebSocket;
        let maxLogLines = 300;
        let logHistory = [];

        const CHAT_HISTORY_KEY = 'chatHistory';
        const LOG_HISTORY_KEY = 'logHistory';
        const THEME_KEY = 'themePreference';
        const SELECTED_MODEL_KEY = 'selectedModel';

        // --- 模型列表获取和加载 ---
        async function loadModelList() {
            try {
                // 保存当前选中的模型ID
                const currentSelectedModel = modelSelector.value || SELECTED_MODEL;
                
                // 清空并显示加载状态
                modelSelector.disabled = true;
                refreshModelsButton.disabled = true;
                modelSelector.innerHTML = '<option value="">加载中...</option>';
                
                const response = await fetch('/v1/models');
                if (!response.ok) throw new Error(`HTTP 错误! 状态: ${response.status}`);
                
                const data = await response.json();
                if (!data.data || !Array.isArray(data.data)) {
                    throw new Error('无效的模型数据格式');
                }
                
                // 清空选择器
                modelSelector.innerHTML = '';
                
                // 添加默认代理模型选项
                const defaultOption = document.createElement('option');
                defaultOption.value = MODEL_NAME;
                defaultOption.textContent = '默认 (使用AI Studio当前模型)';
                modelSelector.appendChild(defaultOption);
                
                // 添加获取到的模型
                data.data.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.display_name || model.id;
                    modelSelector.appendChild(option);
                });
                
                // 恢复之前选中的模型或从localStorage加载
                const savedModel = localStorage.getItem(SELECTED_MODEL_KEY);
                if (savedModel) {
                    // 验证保存的模型是否在当前列表中
                    const modelExists = Array.from(modelSelector.options).some(option => option.value === savedModel);
                    if (modelExists) {
                        modelSelector.value = savedModel;
                        SELECTED_MODEL = savedModel;
                    } else if (currentSelectedModel !== MODEL_NAME) {
                        // 如果保存的模型不在列表中，但有当前使用的非默认模型
                        const currentExists = Array.from(modelSelector.options).some(option => option.value === currentSelectedModel);
                        if (currentExists) {
                            modelSelector.value = currentSelectedModel;
                            SELECTED_MODEL = currentSelectedModel;
                        }
                    }
                } else if (currentSelectedModel !== MODEL_NAME) {
                    // 如果没有保存的模型，但有当前使用的非默认模型
                    const exists = Array.from(modelSelector.options).some(option => option.value === currentSelectedModel);
                    if (exists) {
                        modelSelector.value = currentSelectedModel;
                        SELECTED_MODEL = currentSelectedModel;
                    }
                }
                
                addLogEntry(`[信息] 已加载 ${data.data.length} 个模型`);
            } catch (error) {
                console.error('获取模型列表失败:', error);
                addLogEntry(`[错误] 获取模型列表失败: ${error.message}`);
                
                // 恢复为默认选项
                modelSelector.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = MODEL_NAME;
                defaultOption.textContent = '默认 (使用AI Studio当前模型)';
                modelSelector.appendChild(defaultOption);
                
                // 添加错误提示选项
                const errorOption = document.createElement('option');
                errorOption.disabled = true;
                errorOption.textContent = `加载失败: ${error.message}`;
                modelSelector.appendChild(errorOption);
            } finally {
                modelSelector.disabled = false;
                refreshModelsButton.disabled = false;
            }
        }

        // 监听模型选择器变化
        modelSelector.addEventListener('change', function() {
            const selectedModel = this.value;
            if (selectedModel) {
                SELECTED_MODEL = selectedModel;
                try {
                    localStorage.setItem(SELECTED_MODEL_KEY, selectedModel);
                    addLogEntry(`[信息] 已选择模型: ${selectedModel}`);
                } catch (e) {
                    console.error('保存选择的模型到localStorage失败:', e);
                    addLogEntry('[错误] 保存选择的模型失败');
                }
            }
        });

        // 刷新模型列表按钮
        refreshModelsButton.addEventListener('click', function() {
            addLogEntry('[信息] 正在刷新模型列表...');
            loadModelList();
        });

        // --- Theme Switching ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                htmlRoot.classList.add('dark-mode');
                document.querySelector('#themeToggleButton .theme-text').textContent = '浅色';
                themeToggleButton.title = '切换到亮色模式';
            } else {
                htmlRoot.classList.remove('dark-mode');
                document.querySelector('#themeToggleButton .theme-text').textContent = '深色';
                themeToggleButton.title = '切换到暗色模式';
            }
        }

        function toggleTheme() {
            const currentTheme = htmlRoot.classList.contains('dark-mode') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            applyTheme(newTheme);
            try {
                localStorage.setItem(THEME_KEY, newTheme);
                console.log(`Theme changed to ${newTheme} and saved.`);
            } catch (e) {
                console.error("Error saving theme preference:", e);
                addLogEntry("[错误] 保存主题偏好设置失败。");
            }
        }

        function loadThemePreference() {
            let preferredTheme = 'light';
            try {
                const storedTheme = localStorage.getItem(THEME_KEY);
                if (storedTheme === 'dark' || storedTheme === 'light') {
                    preferredTheme = storedTheme;
                } else {
                    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                        preferredTheme = 'dark';
                        console.log("No stored theme, using system preference: dark");
                    } else {
                        console.log("No stored theme, using default or system preference: light");
                    }
                }
            } catch (e) {
                console.error("Error loading theme preference:", e);
                addLogEntry("[错误] 加载主题偏好设置失败。");
                if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    preferredTheme = 'dark';
                }
            }
            applyTheme(preferredTheme);
            console.log(`Initial theme set to: ${preferredTheme}`);

            // MODIFIED: Add listener for system theme changes
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
            prefersDarkScheme.addEventListener('change', (e) => {
                const newSystemTheme = e.matches ? 'dark' : 'light';
                console.log(`System theme changed. New preference: ${newSystemTheme}`);
                applyTheme(newSystemTheme);
                try {
                    localStorage.setItem(THEME_KEY, newSystemTheme);
                    console.log(`Theme automatically updated to ${newSystemTheme} based on system change and saved.`);
                    addLogEntry(`[信息] 系统主题已更改为 ${newSystemTheme}。`);
                } catch (err) {
                    console.error("Error saving theme preference after system change:", err);
                    addLogEntry("[错误] 保存系统同步的主题偏好设置失败。");
                }
            });
        }

        themeToggleButton.addEventListener('click', toggleTheme);

        // --- Sidebar Toggle ---
        toggleSidebarButton.addEventListener('click', () => {
            const isCollapsed = sidebarPanel.classList.toggle('collapsed');
            updateToggleButton(isCollapsed);
            // positionToggleButton is called by updateToggleButton if needed, 
            // or by resize listener.
        });

        function updateToggleButton(isCollapsed) {
            if (isCollapsed) {
                toggleSidebarButton.innerHTML = '>'; 
                toggleSidebarButton.title = '展开侧边栏';
            } else {
                toggleSidebarButton.innerHTML = '>'; 
                toggleSidebarButton.title = '收起侧边栏';
            }
            positionToggleButton(); // Recalculate position after state change
        }
        
        // MODIFIED: Simplified positionToggleButton
        function positionToggleButton() {
            const isMobile = window.innerWidth <= 768;

            if (isMobile) {
                // On mobile, CSS handles fixed positioning (top: 12px, right: 12px).
                // Clear any inline styles that might have been set by desktop mode.
                toggleSidebarButton.style.left = '';
                toggleSidebarButton.style.right = ''; // CSS `right: 12px !important` in media query will take over
            } else {
                // Desktop: absolute positioning relative to workspace-container
                const isCollapsed = sidebarPanel.classList.contains('collapsed');
                const buttonWidth = toggleSidebarButton.offsetWidth || 36;
                const sidebarWidthString = getComputedStyle(document.documentElement).getPropertyValue('--sidebar-width');
                const sidebarWidth = parseInt(sidebarWidthString, 10) || 380;
                const offset = 10; // Desired space from edge for the button itself

                toggleSidebarButton.style.right = 'auto'; // We will control via 'left'

                if (isCollapsed) {
                    // Position near the right edge of the workspace-container
                    toggleSidebarButton.style.left = `calc(100% - ${buttonWidth}px - ${offset}px)`;
                } else {
                    // Position to the left of the expanded sidebar, centered on its edge
                    toggleSidebarButton.style.left = `calc(100% - ${sidebarWidth}px - ${buttonWidth / 2}px)`;
                }
            }
        }


        function checkInitialSidebarState() {
            if (window.innerWidth <= 768) {
                sidebarPanel.classList.add('collapsed');
            } else {
                sidebarPanel.classList.remove('collapsed');
            }
            updateToggleButton(sidebarPanel.classList.contains('collapsed'));
            // positionToggleButton(); // Called by updateToggleButton
        }

        // --- Log Handling ---
        function updateLogStatus(message, isError = false) {
            if (logStatusElement) {
                logStatusElement.textContent = `[Log Status] ${message}`;
                // 移除内联样式设置，改用CSS类控制颜色
                if (isError) {
                    logStatusElement.classList.add('error-status');
                } else {
                    logStatusElement.classList.remove('error-status');
                }
            }
            console.log(`Log Status: ${message}`);
        }

        function addLogEntry(message) {
            if (!logTerminal) return;
            const logEntry = document.createElement('div');
            logEntry.classList.add('log-entry');
            logEntry.textContent = message;

            logTerminal.appendChild(logEntry);
            logHistory.push(message);

            while (logTerminal.children.length > maxLogLines) {
                logTerminal.removeChild(logTerminal.firstChild);
            }
            while (logHistory.length > maxLogLines) {
                logHistory.shift();
            }
            saveLogHistory();
            const isScrolledNearBottom = logTerminal.scrollHeight - logTerminal.clientHeight <= logTerminal.scrollTop + 50;
            if (isScrolledNearBottom) {
                 logTerminal.scrollTop = logTerminal.scrollHeight;
            }
        }

        function clearLogTerminal() {
            if(logTerminal) {
                logTerminal.innerHTML = '';
                logHistory = [];
                localStorage.removeItem(LOG_HISTORY_KEY);
                addLogEntry('[信息] 日志已手动清除。');
            }
        }
        clearLogButton.addEventListener('click', clearLogTerminal);

        function initializeLogWebSocket() {
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${wsProtocol}//${window.location.host}/ws/logs`;
            updateLogStatus(`尝试连接到 ${wsUrl}...`);
            addLogEntry(`[信息] 正在连接日志流: ${wsUrl}`);

            logWebSocket = new WebSocket(wsUrl);

            logWebSocket.onopen = (event) => {
                updateLogStatus("已连接到日志流。");
                addLogEntry("[成功] 日志 WebSocket 已连接。");
                clearLogButton.disabled = false;
            };

            logWebSocket.onmessage = (event) => {
                if (event.data === "LOG_STREAM_CONNECTED") {
                     console.log("Log stream confirmation received.");
                } else {
                     addLogEntry(event.data);
                }
            };

            logWebSocket.onerror = (event) => {
                updateLogStatus("连接错误！", true);
                console.error("Log WebSocket Error:", event);
                addLogEntry("[错误] 日志 WebSocket 连接失败。");
                clearLogButton.disabled = true;
            };

            logWebSocket.onclose = (event) => {
                let reason = event.reason ? ` Reason: ${event.reason}` : '';
                let statusMsg = event.wasClean ? `连接已关闭 (Code: ${event.code})${reason}` : `连接意外断开 (Code: ${event.code})${reason}。5秒后尝试重连...`;
                let logMsg = `[信息] 日志 WebSocket 连接已关闭 (Code: ${event.code}${reason})`;

                if (!event.wasClean) {
                    setTimeout(initializeLogWebSocket, 5000);
                }
                updateLogStatus(statusMsg, !event.wasClean);
                addLogEntry(logMsg);
                clearLogButton.disabled = true;
            };
        }

        // --- Chat Initialization ---
        function initializeChat() {
            conversationHistory = [ { role: "system", content: SYSTEM_PROMPT } ];
            chatbox.innerHTML = '';
            const historyLoaded = loadChatHistory();
            if (!historyLoaded) {
                displayMessage(SYSTEM_PROMPT, 'system');
                saveChatHistory();
            }
            userInput.disabled = false;
            sendButton.disabled = false;
            clearButton.disabled = false;
            userInput.value = '';
            autoResizeTextarea();
            userInput.focus();
            console.log("Chat initialized.");
            loadLogHistory();
            if (!logWebSocket || logWebSocket.readyState === WebSocket.CLOSED) {
                 initializeLogWebSocket();
                 clearLogButton.disabled = true;
            } else {
                 updateLogStatus("已连接到日志流。");
                 clearLogButton.disabled = false;
            }
        }

        async function loadApiInfo() {
            apiInfoContent.innerHTML = '<div class="loading-indicator"><div class="loading-spinner"></div><span>正在加载 API 信息...</span></div>';
            try {
                const response = await fetch('/api/info');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                const formattedData = {
                    'API Base URL': data.api_base_url ? `<code>${data.api_base_url}</code>` : '未知',
                    'Model Name': data.model_name ? `<code>${data.model_name}</code>` : '未知',
                    'API Key Required': data.api_key_required ? '<span style="color: orange;">⚠️ 是 (请在后端配置)</span>' : '<span style="color: green;">✅ 否</span>'
                };
                displayInfoList(apiInfoContent, formattedData);
            } catch (error) {
                console.error("获取 API 信息失败:", error);
                apiInfoContent.innerHTML = `<div class="info-list"><div><strong style="color: var(--error-msg-text);">错误:</strong> <span style="color: var(--error-msg-text);">加载 API 信息失败: ${error.message}</span></div></div>`;
            }
        }

        async function fetchHealthStatus() {
            if (!healthStatusDisplay) return;
            healthStatusDisplay.innerHTML = '<div class="loading-indicator"><div class="loading-spinner"></div><span>正在加载健康状态...</span></div>';
            try {
                const response = await fetch('/health');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                displayInfoList(healthStatusDisplay, data);
            } catch (error) {
                console.error("获取健康状态失败:", error);
                if (healthStatusDisplay) {
                     healthStatusDisplay.innerHTML = `<div class="info-list"><div><strong style="color: var(--error-msg-text);">错误:</strong> <span style="color: var(--error-msg-text);">加载健康状态失败: ${error.message}</span></div></div>`;
                }
                addLogEntry(`[错误] 获取 /health 状态失败: ${error.message}`);
            }
        }

        function displayInfoList(targetElement, data) {
            if (!targetElement) return;
            let html = '<div class="info-list">';
            for (const key in data) {
                if (Object.hasOwnProperty.call(data, key)) {
                    let value = data[key];
                    if (typeof value === 'object' && value !== null && !Array.isArray(value)) { // 检查是否是对象且非数组
                        // 使用 pre 和 code 标签来格式化对象输出
                        html += `<div><strong>${key}:</strong> <pre style="white-space: pre-wrap; word-break: break-all; background-color: rgba(var(--on-surface-rgb), 0.03); padding: 8px; border-radius: 4px; margin-top: 4px;"><code>${JSON.stringify(value, null, 2)}</code></pre></div>`;
                    } else if (Array.isArray(value)) { // 如果是数组
                         html += `<div><strong>${key}:</strong> <pre style="white-space: pre-wrap; word-break: break-all; background-color: rgba(var(--on-surface-rgb), 0.03); padding: 8px; border-radius: 4px; margin-top: 4px;"><code>${JSON.stringify(value, null, 2)}</code></pre></div>`;
                    }
                    else {
                        html += `<div><strong>${key}:</strong> <span>${value}</span></div>`;
                    }
                }
            }
            html += '</div>';
            targetElement.innerHTML = html;
        }

        function switchView(viewId) {
            if (viewId === 'chat') {
                chatView.style.display = 'flex';
                serverInfoView.style.display = 'none';
                navChatButton.classList.add('active');
                navServerInfoButton.classList.remove('active');
                if (userInput) userInput.focus();
            } else if (viewId === 'server-info') {
                chatView.style.display = 'none';
                serverInfoView.style.display = 'flex'; // Changed to flex for consistency
                navChatButton.classList.remove('active');
                navServerInfoButton.classList.add('active');
                fetchHealthStatus();
                loadApiInfo();
            }
        }

        navChatButton.addEventListener('click', () => switchView('chat'));
        navServerInfoButton.addEventListener('click', () => switchView('server-info'));

        refreshServerInfoButton.addEventListener('click', async () => {
            refreshServerInfoButton.disabled = true;
            refreshServerInfoButton.textContent = '刷新中...';
            addLogEntry("[信息] 手动刷新服务器状态...");
            if (apiInfoContent) apiInfoContent.innerHTML = '<div class="loading-indicator"><div class="loading-spinner"></div><span>正在加载 API 信息...</span></div>';
            if (healthStatusDisplay) healthStatusDisplay.innerHTML = '<div class="loading-indicator"><div class="loading-spinner"></div><span>正在加载健康状态...</span></div>';
            try {
                await Promise.all([loadApiInfo(), fetchHealthStatus()]);
                addLogEntry("[成功] 服务器状态已刷新。");
            } catch (error) {
                console.error("Error during manual refresh:", error);
                addLogEntry("[错误] 手动刷新服务器状态失败。");
            } finally {
                setTimeout(() => {
                    refreshServerInfoButton.disabled = false;
                    refreshServerInfoButton.textContent = '刷新';
                }, 300);
            }
        });

        loadThemePreference();
        initializeChat();
        loadApiInfo();
        fetchHealthStatus();
        setInterval(fetchHealthStatus, 30000);
        checkInitialSidebarState();
        loadModelList(); // 加载模型列表
        window.addEventListener('resize', () => {
            checkInitialSidebarState(); // This will also call positionToggleButton
        });


        sendButton.addEventListener('click', sendMessage);
        clearButton.addEventListener('click', () => {
             if (confirm("确定要清除所有聊天记录吗？此操作也会清除浏览器缓存。")) {
                 localStorage.removeItem(CHAT_HISTORY_KEY);
                 initializeChat();
             }
        });
        userInput.addEventListener('keydown', (event) => {
             if (event.key === 'Enter' && !event.shiftKey) {
                 event.preventDefault();
                 sendMessage();
             }
        });
        userInput.addEventListener('input', autoResizeTextarea);
        autoResizeTextarea();

        function autoResizeTextarea() {
            const target = userInput;
            target.style.height = 'auto';
            const maxHeight = parseInt(getComputedStyle(target).maxHeight) || 200;
            const scrollHeight = target.scrollHeight;
            if (scrollHeight > maxHeight) {
                 target.style.height = maxHeight + 'px';
                 target.style.overflowY = 'auto';
             } else {
                 target.style.height = scrollHeight + 'px';
                 target.style.overflowY = 'hidden';
             }
        }

        async function sendMessage() {
             const messageText = userInput.value.trim();
             if (!messageText) return;
             userInput.disabled = true;
             sendButton.disabled = true;
             clearButton.disabled = true;
             try {
                 conversationHistory.push({ role: 'user', content: messageText });
                 const userMsgIndex = conversationHistory.length - 1;
                 displayMessage(messageText, 'user', userMsgIndex);
                 userInput.value = '';
                 autoResizeTextarea();
                 saveChatHistory();

                 const assistantMsgIndex = conversationHistory.length;
                 const assistantMsgElement = displayMessage('', 'assistant', assistantMsgIndex);
                 assistantMsgElement.classList.add('streaming');
                 chatbox.scrollTop = chatbox.scrollHeight;

                 let fullResponse = '';
                 const response = await fetch(API_URL, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({
                         messages: conversationHistory,
                         model: SELECTED_MODEL, // 使用选定的模型
                         stream: true
                     })
                 });

                 if (!response.ok) {
                     let errorBody = {}, errorText = `HTTP Error: ${response.status} ${response.statusText}`;
                     try {
                         const text = await response.text();
                         try { errorBody = JSON.parse(text); } catch (e) { errorBody = {detail: text};}
                         errorText = errorBody.detail || errorBody.error?.message || text;
                     } catch (e) { /* Ignore */ }
                     throw new Error(errorText);
                 }

                 const reader = response.body.getReader();
                 const decoder = new TextDecoder();
                 let buffer = '';
                 while (true) {
                     const { done, value } = await reader.read();
                     if (done) break;
                     buffer += decoder.decode(value, { stream: true });
                     let boundary = buffer.indexOf('\n\n');
                     while (boundary >= 0) {
                          const line = buffer.substring(0, boundary).trim();
                          buffer = buffer.substring(boundary + 2);
                         if (line.startsWith('data: ')) {
                             const data = line.substring(6).trim();
                             if (data === '[DONE]') continue;
                             try {
                                 const chunk = JSON.parse(data);
                                 if (chunk.error) throw new Error(chunk.error.message || "Unknown stream error");
                                 const delta = chunk.choices?.[0]?.delta?.content || '';
                                 if (delta) {
                                     fullResponse += delta;
                                     const isScrolledToBottom = chatbox.scrollHeight - chatbox.clientHeight <= chatbox.scrollTop + 15; // Adjusted tolerance
                                     assistantMsgElement.querySelector('.message-content').textContent += delta; // Append to content div
                                     if (isScrolledToBottom) chatbox.scrollTop = chatbox.scrollHeight;
                                 }
                                 if (chunk.choices?.[0]?.finish_reason) console.log("Stream finish reason:", chunk.choices[0].finish_reason);
                             } catch (e) {
                                 console.error('Error parsing stream chunk:', data, e);
                                 addLogEntry(`[错误] 解析流数据块失败: ${e.message}. 数据: ${data}`);
                             }
                         }
                         boundary = buffer.indexOf('\n\n');
                     }
                 }
                 
                 renderMessageContent(assistantMsgElement.querySelector('.message-content'), fullResponse); // Final render on content div

                 if (fullResponse) {
                     conversationHistory.push({ role: 'assistant', content: fullResponse });
                     assistantMsgElement.dataset.index = assistantMsgIndex;
                     saveChatHistory();
                 } else {
                     console.warn("Stream finished with empty response.");
                     assistantMsgElement.remove();
                      if (conversationHistory[conversationHistory.length - 1]?.role === 'user') {
                          conversationHistory.pop();
                          saveChatHistory();
                          const userMessages = chatbox.querySelectorAll('.user-message');
                          if (userMessages.length > 0) userMessages[userMessages.length - 1].remove();
                      }
                 }
             } catch (error) {
                 console.error('Error sending message:', error);
                 const errorText = `喵... 出错了: ${error.message || '未知错误'} >_<`;
                 displayMessage(errorText, 'error');
                 addLogEntry(`[错误] 发送消息失败: ${error.message}`);
                 const streamingMsg = chatbox.querySelector('.assistant-message.streaming');
                 if (streamingMsg) streamingMsg.remove();
                 if (conversationHistory[conversationHistory.length - 1]?.role === 'user') {
                     conversationHistory.pop();
                     saveChatHistory();
                     const userMessages = chatbox.querySelectorAll('.user-message');
                     if (userMessages.length > 0) userMessages[userMessages.length - 1].remove();
                 }
             } finally {
                 userInput.disabled = false;
                 sendButton.disabled = false;
                 clearButton.disabled = false;
                 const finalAssistantMsg = Array.from(chatbox.querySelectorAll('.assistant-message.streaming')).pop();
                 if (finalAssistantMsg) finalAssistantMsg.classList.remove('streaming');
                 userInput.focus();
                 chatbox.scrollTop = chatbox.scrollHeight;
             }
        }

        function displayMessage(text, role, index) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            if ([ 'user', 'assistant', 'system', 'error' ].includes(role)) {
                messageElement.classList.add(`${role}-message`);
            }
            if (index !== undefined && (role === 'user' || role === 'assistant')) {
                messageElement.dataset.index = index;
            }
            const messageContentElement = document.createElement('div');
            messageContentElement.classList.add('message-content');
            if (text || role === 'system' || (role === 'assistant' && text === '')) { // Allow empty initial for streaming assistant
                 renderMessageContent(messageContentElement, text);
            }
            messageElement.appendChild(messageContentElement);
            chatbox.appendChild(messageElement);
             setTimeout(() => {
                 if (chatbox.lastChild === messageElement) {
                    chatbox.scrollTop = chatbox.scrollHeight;
                 }
             }, 0);
            return messageElement; // Return the main message element
        }

        function renderMessageContent(element, text) {
             if (text == null) {
                 element.innerHTML = ''; return;
             }
             const escapeHtml = (unsafe) => unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
             let safeText = escapeHtml(String(text));
             const blockRegex = /```(?:[\w-]*\n)?([\s\S]+?)\n?```/g;
             safeText = safeText.replace(blockRegex, (match, code) => `<pre><code>${code.trim()}</code></pre>`);
             const inlineCodeRegex = /`([^`]+)`/g;
             safeText = safeText.replace(inlineCodeRegex, '<code>$1</code>');
             const links = [];
             const linkRegex = /\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g;
             safeText = safeText.replace(linkRegex, (match, linkText, url) => {
                 links.push({ text: linkText, url: url });
                 return `__LINK_${links.length - 1}__`;
             });
             const boldRegex = /(\*\*|__)(?=\S)([\s\S]*?\S)\1/g;
             safeText = safeText.replace(boldRegex, '<strong>$2</strong>');
             const italicRegex = /(\*|_)(?=\S)([\s\S]*?\S)\1/g;
             safeText = safeText.replace(italicRegex, '<em>$2</em>');
             safeText = safeText.replace(/__LINK_(\d+)__/g, (match, index) => {
                 const link = links[parseInt(index)];
                 return `<a href="${escapeHtml(link.url)}" target="_blank" rel="noopener noreferrer">${link.text}</a>`;
             });
             element.innerHTML = safeText; // white-space: pre-wrap on .assistant-message handles newlines mostly
             if (typeof hljs !== 'undefined' && element.querySelectorAll('pre code').length > 0) {
                  element.querySelectorAll('pre code').forEach((block) => hljs.highlightElement(block));
             }
        }

        function saveChatHistory() {
            try { localStorage.setItem(CHAT_HISTORY_KEY, JSON.stringify(conversationHistory)); }
            catch (e) { console.error("Error saving chat history:", e); addLogEntry("[错误] 保存聊天记录失败。"); }
        }

        function loadChatHistory() {
            try {
                const storedHistory = localStorage.getItem(CHAT_HISTORY_KEY);
                if (storedHistory) {
                    const parsedHistory = JSON.parse(storedHistory);
                    if (Array.isArray(parsedHistory) && parsedHistory.length > 0 && parsedHistory[0].role === 'system') {
                        conversationHistory = parsedHistory;
                        for (let i = 1; i < conversationHistory.length; i++) { // Skip system prompt
                            displayMessage(conversationHistory[i].content, conversationHistory[i].role, i);
                        }
                        addLogEntry("[信息] 从 localStorage 加载了聊天记录。");
                        return true;
                    } else { localStorage.removeItem(CHAT_HISTORY_KEY); }
                }
            } catch (e) { console.error("Error loading chat history:", e); addLogEntry("[错误] 加载聊天记录失败。"); localStorage.removeItem(CHAT_HISTORY_KEY); }
            return false;
        }

        function saveLogHistory() {
            try { localStorage.setItem(LOG_HISTORY_KEY, JSON.stringify(logHistory)); }
            catch (e) { console.error("Error saving log history:", e); }
        }

        function loadLogHistory() {
            try {
                const storedLogs = localStorage.getItem(LOG_HISTORY_KEY);
                if (storedLogs) {
                    const parsedLogs = JSON.parse(storedLogs);
                    if (Array.isArray(parsedLogs)) {
                        logHistory = parsedLogs;
                        logTerminal.innerHTML = '';
                        parsedLogs.forEach(logMsg => {
                            const logEntry = document.createElement('div');
                            logEntry.classList.add('log-entry');
                            logEntry.textContent = logMsg;
                            logTerminal.appendChild(logEntry);
                        });
                        logTerminal.scrollTop = logTerminal.scrollHeight;
                        return true;
                    }
                }
            } catch (e) { console.error("Error loading log history:", e); localStorage.removeItem(LOG_HISTORY_KEY); }
            return false;
        }
    </script>
    <!-- Optional: Add highlight.js for code syntax highlighting -->
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/stackoverflow-dark.min.css"> -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script> -->
    <!-- <script>hljs.highlightAll();</script> -->
</body>
</html>